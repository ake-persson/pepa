#!/bin/bash

set -e
set -u

readonly USER='salt_vcs'
readonly BASEDIR='/srv/pepa'
readonly SSH_KEY="${BASEDIR}/.ssh/id_dsa"
readonly URI='Path to Git repo'

export GIT_SSH="${BASEDIR}/bin/ssh_git"

sync() {
    local uri="$1" branch="$2" dir="$3"

    if [ -d ${dir}/.git ]; then
        ( cd $dir; git reset --hard; git pull )
    else
        rm -rf ${dir}
        git clone -b ${branch} ${uri} ${dir}
    fi
}

if [ $( id -un ) != 'pepa' ]; then
    echo "You need to run this script as the user pepa"
    exit 1
fi

sync ${USER}@${URI} master ${BASEDIR}/base
BRANCHES=$( cd ${BASEDIR}/base; git branch --all | awk -F'/' '{ print $3 }' | grep -vE '(^$|HEAD|master)' )
for branch in ${BRANCHES}; do
    sync ${USER}@${URI} ${branch} ${BASEDIR}/${branch}
done
